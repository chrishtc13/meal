<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>算分</title>
    <style>
        .scroll-container {
            display: inline-block;
            padding: 5px;
            margin: 2px;
            font-family: Courier New;
            font-weight: bold;
        }

        .scroll-container_1 {
            display: inline-block;
            overflow-x: auto;
            padding: 5px;
            margin: 2px;
            height: 200px;
            width: 220px;
        }

        .scroll-container_2 {
            display: inline-block;
            overflow-x: auto;
            padding: 5px;
            margin: 2px;
            height: 200px;
            width: 220px;
        }

        #clickShow {
            width: 80%;
            height: 50%;
            border-radius: 10px;
            padding: 5px;
            margin: 2px;
            background-color: rgba(227, 183, 59, 0.571);
            color: black;
            transition: background-color 0.3s, color 0.3s;
            font-family: Century Gothic;
            font-size: 20px;
            font-weight: bold;
        }

        #txt_1 {
            width: 90px;
            height: 20px;
            border-radius: 10px;
            text-align: center;
            align-items: center;
            justify-content: center;
            display:inline-flex;
            padding: 8px;
            margin-bottom: 5px;
            background-color: rgba(243, 236, 44, 0.571);
            color: black;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-family: Century Gothic;
            font-size: 20px;
            font-weight: bold;
        }

        #txt_1.active {
            background-color: orange;
            color: white;
        }

        #txt_2 {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            align-items: center;
            justify-content: center;
            display:inline-flex;
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid gray;
            background-color: white;
            color: black;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-family: Century Gothic;
            font-size: 25px;
            font-weight: bold;
        }

        #txt_2.active {
            background-color: orange;
            color: white;
        }

        #player_me {
            width: 260px;
            height: 150px;
            border-radius: 10px;
            display:inline-block;
            padding: 5px;
            margin: 2px;
            background-color: rgba(205, 188, 188, 0.934);
            color: black;
            transition: background-color 0.3s, color 0.3s;
            font-family: Century Gothic;
            font-size: 20px;
            font-weight: bold;
        }

        #player_rest {
            width: 95%;
            height: 72%;
            border-radius: 10px;
            overflow-x: auto;
            padding: 5px;
            margin: 2px;
            background-color: rgba(245, 226, 212, 0.863);
            color: black;
            transition: background-color 0.3s, color 0.3s;
            font-family: Century Gothic;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="scroll-container_1">
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">君</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">大姊夫</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">二姊夫</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">婆婆</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">小姨丈</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">小姨</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">潔</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">大姊</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">二姊</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">ㄚ</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">彤</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">媽媽</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">寶</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">福</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">瑞</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">米老鼠</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">牛魔王</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">笑面虎</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">兔寶寶</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">海龍王</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">蛇蓮娜</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">赤兔馬</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">大肥羊</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">美猴王</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">金雞母</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">史奴比</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">豬小弟</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">頑皮豹</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">小叮噹</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">加菲貓</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">長毛象</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">獅子王</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">九尾狐</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">飛天貓</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">哈士奇</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">黃金犬</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">米格魯</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">拉不拉多</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">大尾巴狼</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">海王子</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">美人魚</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">小蝦米</div>
        <div id="txt_1" onclick="hck(this)" onmouseleave="handleMouseLeave(this)" player="y">大鯨魚</div>
    </div>

    <div class="scroll-container_1" style="width:100px">
        <div id="txt_1" onclick="resetOne()">按錯</div><br>
    </div>

    <div class="scroll-container_2">
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">1</div>
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">2</div>
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">3</div>
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">4</div>
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">5</div>
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">6</div>
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">7</div>
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">8</div>
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">9</div>
        <div id="txt_2" onclick="hck(this)" onmouseleave="handleMouseLeave(this)">0</div>

        <div id="txt_2" style="visibility:hidden">space</div>

        <div id="txt_2" onclick="hck(this)" style="color:white; background-color:rgb(170, 13, 13);">。</div>
    </div>

    <div id="clickShow" style="display:none"></div>

    <br>
    <div id="gameResultShow" class="scroll-container"></div>
    <br>
    <div id="gameRecordShow" class="scroll-container"></div>

    <script>
        show_game_result();
        var valueList = "";
        var valueListShow = "";
        var clickTimes = 0;
        var currentWinner = "";
        var currentLosers = [];
        var winner_this_one = "";
        var loser_this_one = "";
        var score_this_one = 0;
        var serial_number = 0;

        function hck(e) {
		    e.classList.add('active');

            clickTimes++;
            if (! checkClickTimes(e.innerText)) { clickTimes--; return; }

            pap = isNumber(e.innerText) || e.innerText == '。' ? '' : ',';
            valueList = valueList + pap + e.innerText + pap;
            valueListShow = valueList.replaceAll(",,",",").replaceAll("。","").substring(1);

            // 結算這一局
            if (e.innerText == '。') {
                var game_record_this_one = valueListShow.split(",");
                var serial = 0;
                var win_lose_one = [];
                var win_lose_all = [];
                game_record_this_one.forEach((input) => {
                    serial++;
                    if (serial > 1) {
                        if (! isNumber(input)) { win_lose_one = [currentWinner, input, 0]; win_lose_all.push(win_lose_one); }
                        if (isNumber(input)) { win_lose_all.forEach((ws) => { if (ws[2] == 0) ws[2] = input }) }
                    }
                });

                serial_number = sessionStorage.getItem('serial_number');
                serial_number++;
                var bgColor = serial_number % 2 ? " #ccd1d1" : " #aeb6bf"
                var currentTime = (new Date()).toLocaleTimeString();

                win_lose_all.forEach((ws) => {
                    score_this_one = parseInt(ws[2]);
                    if (score_this_one > 0) {
                        valueList = ws[0] + "," + ws[1] + "," + ws[2];
                        regex = /^[^0-9]+,[^0-9]+,[0-9]+$/;
                        if (regex.test(valueList)) {
                            set_game_result(valueList);
                            valueListShow = "<tr bgcolor=" + bgColor + "><td>" + currentTime + "</td><td>" + serial_number + "</td><td>" + ws[0] + "</td><td>贏</td><td>" + ws[1] + "</td><td>" + score_this_one + "</td></tr>";
                            var allGamesShow = sessionStorage.getItem('allGamesShow');
                            allGamesShow = allGamesShow ? allGamesShow + valueListShow : valueListShow;
                            sessionStorage.setItem('allGamesShow', allGamesShow);
                            sessionStorage.setItem('serial_number', serial_number);
                            show_game_result();
                        }
                    }
                    resetOne();
                })
            } else {
                document.getElementById('clickShow').style.display = "block";
                // replace the first "," only
                document.getElementById('clickShow').innerHTML = valueListShow.replace(",","贏");
            }
        }

        function set_game_result(v) {
            var game_result = JSON.parse(sessionStorage.getItem('allGamesResult'));
            game_result = game_result == null ? {} : game_result;

            var game_record_this_one = v.split(",");
            winner_this_one = game_record_this_one[0];
            loser_this_one = game_record_this_one[1];
            score_this_one = parseInt(game_record_this_one[2]);

            var pn;

            pn = (winner_this_one + "輸贏");
            if (game_result[pn] === undefined) { game_result[pn] = 0 }
            game_result[pn] += score_this_one;

            pn = (loser_this_one + "輸贏");
            if (game_result[pn] === undefined) { game_result[pn] = 0 }
            game_result[pn] -= score_this_one;

            if (game_result[winner_this_one] === undefined) { game_result[winner_this_one] = {}; } 
            if (game_result[loser_this_one] === undefined) { game_result[loser_this_one] = {}; } 
            if (game_result[winner_this_one][loser_this_one] === undefined) { game_result[winner_this_one][loser_this_one] = 0; } 
            if (game_result[loser_this_one][winner_this_one] === undefined) { game_result[loser_this_one][winner_this_one] = 0; } 

            game_result[winner_this_one][loser_this_one] += score_this_one;
            game_result[loser_this_one][winner_this_one] -= score_this_one;

            sessionStorage.setItem('allGamesResult', JSON.stringify(game_result));
        }

        function show_game_result() {
            // user defined players
            var params = new URLSearchParams(document.location.search);
            if (params.get("p")) {
                var ud_players = get_players(params.get("p").replaceAll("，",",").replace(/[^a-zA-Z,\u4e00-\u9fff]/g, '').split(","));
                if (ud_players != null && ud_players.length > 1) {
                    var player_serial = 0;
                    document.querySelectorAll('div').forEach((input) => {
                        if (input.getAttribute("player") == "y") {
                            if (player_serial < ud_players.length && !isNumber(ud_players[player_serial]) && ud_players[player_serial] ) {
                                input.innerText = ud_players[player_serial];
                                input.style.display = "inline-flex";
                            } else {
                                input.style.display = "none";
                            }
                            player_serial++;
                        }
                    });
                }
            }
            //
            
            var allGamesShow = sessionStorage.getItem('allGamesShow');
            if (allGamesShow == null) return;

            document.getElementById('gameRecordShow').innerHTML = "<table height=0 cellpadding=6 cellspacing=1>" + allGamesShow + "</table>";

            var game_result = JSON.parse(sessionStorage.getItem('allGamesResult'));

            var sortedArray = Object.entries(game_result);

            sortedArray.sort((a, b) => b[1] - a[1]);
            var sortedObject = Object.fromEntries(sortedArray);
            var result = ""
            var player_one = "";
            var highlight = "";
            var lose = false;

            for (var key in sortedObject) {
                player_one = key;
                if (player_one.indexOf("輸贏") == -1) { continue }

                player_one = key.replace("輸贏","");
                
                lose = (parseInt(sortedObject[key]) < 0);
                result += "<div id='player_me'>" + player_one + "&nbsp";
                result += (lose ? "<font color=red>" : "") + sortedObject[key] + (lose ? "</font>" : "")

                sortedArray2 = Object.entries(game_result[player_one]);
                sortedArray2.sort((a, b) => b[1] - a[1]);
                sortedObject2 = Object.fromEntries(sortedArray2);
                result2 = "<div id='player_rest'>";
                for (var key2 in sortedObject2) {
                    if (parseInt(sortedObject2[key2]) != 0) {
                        result2 += key2 + "&nbsp" + sortedObject2[key2] + "<br>";
                    }
                }
                result2 += "</div></div>";

                result += result2;
            }
 
            document.getElementById('gameResultShow').innerHTML = result;
        }

        function resetOne() {
            valueList = "";
            valueListShow = "";
            clickTimes = 0;
            currentWinner = "";
            currentLosers = [];
            document.getElementById('clickShow').style.display = "none";
            document.getElementById('clickShow').innerHTML = "";
        }

        function checkClickTimes(v) {
            if (clickTimes == 1) { currentWinner = v; }
            if (clickTimes >= 2) {
                if (v == currentWinner) { return false }
                if ((! isNumber(v)) && ( v != "。")) {
                    if (! currentLosers.includes(v)) { currentLosers.push(v) } else { return false }
                }
            }
            if (clickTimes <= 2) {
                if (isNumber(v) || v == "。") { return false; }
            }

            return true;
        }

        function isNumber(value) {
            return /^\d+$/.test(value);
        }

        function handleMouseLeave(e) {
            e.classList.remove('active');
        }

        function get_players(arr) {
            const cleaned = arr.map(item => item.replace(/\s/g, ''));
            return [...new Set(cleaned)];
        }
</script>
</body>
</html>
